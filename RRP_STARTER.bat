@echo off
title Server Restarter with Scheduled Shutdowns

:: ????????? ???????
set ARMApath=C:\SERVER
set level=@RRPServer
set port=2302
set mod=@1368860933;
set srvmod=@RRPServer;@extensions;@arametrics
set profile_name=%level%
set server_cfg=%level%\config.cfg
set basic_cfg=%level%\basic.cfg
set extra_launch_parameters=-debug -autoinit -enableHT -hugepages -maxMem=32000 -malloc=tbb4malloc_bi_x64 -limitFPS=999
set loops=0

:initial_kill
echo SERVER NOW KILLING - 10 SECONDS REMAINING
timeout /t 10

:: ??????? ????????
echo Killing existing server processes...
taskkill /IM arma3server_x64.exe /F 2>NUL
taskkill /IM arma3server.exe /F 2>NUL
timeout /t 3
taskkill /IM arma3server_x64.exe /F 2>NUL
taskkill /IM arma3server.exe /F 2>NUL
echo Server processes terminated.
timeout /t 30

:start
cls
:: ????????, ??????? ?? ??????
tasklist /FI "IMAGENAME eq arma3server_x64.exe" 2>NUL | find /I /N "arma3server_x64.exe">NUL
if "%ERRORLEVEL%"=="0" goto loop

echo Server not found, starting...
echo Server started: %date%_%time%
if "%loops%" NEQ "0" (
    echo Restarts: %loops%
)
set /A loops+=1

:: ??????? ? ????? ? ?????? ???????
echo Switching to ARMA3 directory...
cd /d "%ARMApath%"

echo Starting Arma 3 server...
start "%profile_name%" /HIGH /min /wait "arma3server_x64.exe" -servermod=%srvmod% -mod=%mod% "-config=%server_cfg%" "-cfg=%basic_cfg%" "-profiles=%profile_name%" "-name=%profile_name%" -port=%port% %extra_launch_parameters%

:: ????????? ?? ???????? ???????
echo ?????? ??????? ???????! ??? ??????????? ?????????? ??? ??????????? ???????? ?? ????? ?????: https://rocketrp.ru/
goto started

:loop
cls
echo Server is running, monitoring...

:: ???????? ??????? ??? ?????????? (00:00, 04:00, 08:00, 12:00, 16:00, 20:00)
for /f "tokens=1-2 delims=:" %%i in ("%time%") do (
    set hour=%%i
    set minute=%%j
)
:: ??????? ??????? ??????? ?? ???? (????????, " 8" > "8")
if "%hour:~0,1%"==" " set hour=%hour:~1%

:: ?????????, ????????????? ?? ????? ?????? ?? ??????? ????????
if "%minute:~0,2%"=="00" (
    if "%hour%"=="00" goto shutdown
    if "%hour%"=="04" goto shutdown
    if "%hour%"=="08" goto shutdown
    if "%hour%"=="12" goto shutdown
    if "%hour%"=="16" goto shutdown
    if "%hour%"=="20" goto shutdown
)

:started
timeout /t 5
tasklist /FI "IMAGENAME eq arma3server_x64.exe" 2>NUL | find /I /N "arma3server_x64.exe">NUL
if "%ERRORLEVEL%"=="0" goto loop

:: ???? ?????? ???????? ?????? ???, ??????????
echo Server stopped unexpectedly, restarting...
taskkill /IM arma3server_x64.exe /F 2>NUL
goto start

:shutdown
echo Scheduled shutdown at %time%...
taskkill /IM arma3server_x64.exe /F 2>NUL
echo Server stopped. Waiting 30 seconds before restart...
timeout /t 30
goto start